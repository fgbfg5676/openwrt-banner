name: Sync Banner Logic

on:
  push:
    paths:
      - "banner.json"    # 仅当 banner.json 修改时触发
  workflow_dispatch:     # 也支持手动触发

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: 检出代码
      uses: actions/checkout@v3

    - name: 读取 banner.json
      id: read_banner
      run: |
        echo "读取 banner.json..."
        cat banner.json

        # 使用 jq 提取 JSON 字段
        TEXT=$(jq -r '.text' banner.json)
        COLOR=$(jq -r '.color' banner.json)

        # 设置输出
        echo "text=$TEXT" >> $GITHUB_OUTPUT
        echo "color=$COLOR" >> $GITHUB_OUTPUT

    - name: 生成 OpenWrt banner
      run: |
        echo "生成 OpenWrt 格式 banner 文件 ..."
        {
          echo "================================================="
          echo "  🎉 OpenWrt Custom Build"
          echo "================================================="
          echo ""
          echo "${{ steps.read_banner.outputs.text }}"
          echo ""
          echo "(配色参考: ${{ steps.read_banner.outputs.color }})"
          echo "================================================="
        } > banner

        echo "生成完成，内容如下:"
        cat banner

    - name: 提交更新
      run: |
        git config user.name "banner-sync-bot"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add banner
        if ! git diff --staged --quiet; then
          git commit -m "🔄 自动生成 OpenWrt banner - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
        else
          echo "ℹ️ 无变化，跳过提交"
        fi
