name: Sync Banner Logic

on:
  push:
    paths:
      - "banner.json"    # ä»…å½“ banner.json ä¿®æ”¹æ—¶è§¦å‘
  workflow_dispatch:     # ä¹Ÿæ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  update:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v3

    - name: è¯»å– banner.json
      id: read_banner
      run: |
        echo "è¯»å– banner.json..."
        cat banner.json

        # ä½¿ç”¨ jq æå– JSON å­—æ®µ
        TEXT=$(jq -r '.text' banner.json)
        COLOR=$(jq -r '.color' banner.json)

        # è®¾ç½®è¾“å‡º
        echo "text=$TEXT" >> $GITHUB_OUTPUT
        echo "color=$COLOR" >> $GITHUB_OUTPUT

    - name: ç”Ÿæˆ OpenWrt banner
      run: |
        echo "ç”Ÿæˆ OpenWrt æ ¼å¼ banner æ–‡ä»¶ ..."
        {
          echo "================================================="
          echo "  ğŸ‰ OpenWrt Custom Build"
          echo "================================================="
          echo ""
          echo "${{ steps.read_banner.outputs.text }}"
          echo ""
          echo "(é…è‰²å‚è€ƒ: ${{ steps.read_banner.outputs.color }})"
          echo "================================================="
        } > banner

        echo "ç”Ÿæˆå®Œæˆï¼Œå†…å®¹å¦‚ä¸‹:"
        cat banner

    - name: æäº¤æ›´æ–°
      run: |
        git config user.name "banner-sync-bot"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git add banner
        if ! git diff --staged --quiet; then
          git commit -m "ğŸ”„ è‡ªåŠ¨ç”Ÿæˆ OpenWrt banner - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git push
        else
          echo "â„¹ï¸ æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
        fi
